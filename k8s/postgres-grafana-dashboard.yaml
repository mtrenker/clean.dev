apiVersion: v1
kind: ConfigMap
metadata:
  name: postgres-grafana-dashboard
  namespace: clean-dev
  labels:
    grafana_dashboard: "1"
data:
  postgres-dashboard.json: |
    {"title":"Clean.dev PostgreSQL","tags":["postgresql","cnpg"],"timezone":"browser","schemaVersion":16,"refresh":"30s","time":{"from":"now-1h","to":"now"},"panels":[{"datasource":"Prometheus","fieldConfig":{"defaults":{"unit":"short","thresholds":{"mode":"absolute","steps":[{"color":"green","value":null},{"color":"yellow","value":50},{"color":"red","value":80}]}}},"gridPos":{"h":4,"w":6,"x":0,"y":0},"id":1,"options":{"colorMode":"value","graphMode":"area","reduceOptions":{"calcs":["lastNotNull"]}},"targets":[{"expr":"sum(cnpg_pg_stat_database_numbackends{datname=\"cleandev\"})","refId":"A"}],"title":"Active Connections","type":"stat"},{"datasource":"Prometheus","fieldConfig":{"defaults":{"unit":"percentunit","min":0,"max":1,"thresholds":{"mode":"absolute","steps":[{"color":"red","value":null},{"color":"yellow","value":0.8},{"color":"green","value":0.9}]}}},"gridPos":{"h":4,"w":6,"x":6,"y":0},"id":2,"options":{"showThresholdMarkers":true,"reduceOptions":{"calcs":["lastNotNull"]}},"targets":[{"expr":"cnpg_cache_hit_ratio{datname=\"cleandev\"}","refId":"A"}],"title":"Cache Hit Ratio","type":"gauge"},{"datasource":"Prometheus","fieldConfig":{"defaults":{"unit":"bytes","thresholds":{"mode":"absolute","steps":[{"color":"green","value":null}]}}},"gridPos":{"h":4,"w":6,"x":12,"y":0},"id":3,"options":{"colorMode":"value","graphMode":"area","reduceOptions":{"calcs":["lastNotNull"]}},"targets":[{"expr":"cnpg_database_size{datname=\"cleandev\"}","refId":"A"}],"title":"Database Size","type":"stat"},{"datasource":"Prometheus","fieldConfig":{"defaults":{"mappings":[{"options":{"0":{"color":"red","text":"Down"}},"type":"value"},{"options":{"1":{"color":"green","text":"Up"}},"type":"value"}]}},"gridPos":{"h":4,"w":6,"x":18,"y":0},"id":4,"options":{"colorMode":"background","graphMode":"none","reduceOptions":{"calcs":["lastNotNull"]}},"targets":[{"expr":"cnpg_pg_database_up{datname=\"cleandev\"}","refId":"A"}],"title":"Status","type":"stat"},{"datasource":"Prometheus","fieldConfig":{"defaults":{"unit":"ops","custom":{"drawStyle":"line","fillOpacity":10,"lineWidth":1,"showPoints":"never"}}},"gridPos":{"h":8,"w":12,"x":0,"y":4},"id":5,"options":{"legend":{"displayMode":"table","placement":"bottom","calcs":["mean","last"]},"tooltip":{"mode":"single"}},"targets":[{"expr":"rate(cnpg_pg_stat_database_xact_commit{datname=\"cleandev\"}[5m])","legendFormat":"Commits","refId":"A"},{"expr":"rate(cnpg_pg_stat_database_xact_rollback{datname=\"cleandev\"}[5m])","legendFormat":"Rollbacks","refId":"B"}],"title":"Transaction Rate","type":"timeseries"},{"datasource":"Prometheus","fieldConfig":{"defaults":{"unit":"percent","custom":{"drawStyle":"line","fillOpacity":10,"lineWidth":1,"showPoints":"never"}}},"gridPos":{"h":8,"w":12,"x":12,"y":4},"id":6,"options":{"legend":{"displayMode":"table","placement":"bottom","calcs":["mean","max"]},"tooltip":{"mode":"single"}},"targets":[{"expr":"rate(container_cpu_usage_seconds_total{namespace=\"clean-dev\",pod=~\"clean-dev-pg-.*\"}[5m]) * 100","legendFormat":"{{pod}}","refId":"A"}],"title":"CPU Usage","type":"timeseries"},{"datasource":"Prometheus","fieldConfig":{"defaults":{"unit":"bytes","custom":{"drawStyle":"line","fillOpacity":10,"lineWidth":1,"showPoints":"never"}}},"gridPos":{"h":8,"w":12,"x":0,"y":12},"id":7,"options":{"legend":{"displayMode":"table","placement":"bottom","calcs":["mean","max"]},"tooltip":{"mode":"single"}},"targets":[{"expr":"container_memory_working_set_bytes{namespace=\"clean-dev\",pod=~\"clean-dev-pg-.*\"}","legendFormat":"{{pod}}","refId":"A"}],"title":"Memory Usage","type":"timeseries"},{"datasource":"Prometheus","fieldConfig":{"defaults":{"unit":"short","custom":{"drawStyle":"line","fillOpacity":10,"lineWidth":1,"showPoints":"never"}}},"gridPos":{"h":8,"w":12,"x":12,"y":12},"id":8,"options":{"legend":{"displayMode":"table","placement":"bottom","calcs":["mean","last"]},"tooltip":{"mode":"single"}},"targets":[{"expr":"cnpg_connection_stats{datname=\"cleandev\",state=\"active\"}","legendFormat":"Active","refId":"A"},{"expr":"cnpg_connection_stats{datname=\"cleandev\",state=\"idle\"}","legendFormat":"Idle","refId":"B"},{"expr":"cnpg_connection_stats{datname=\"cleandev\",state=\"idle_in_transaction\"}","legendFormat":"Idle in TX","refId":"C"}],"title":"Connections by State","type":"timeseries"}]}
