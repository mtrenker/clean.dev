apiVersion: apps/v1
kind: Deployment
metadata:
  name: clean-dev
spec:
  replicas: 1
  revisionHistoryLimit: 3
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxUnavailable: 0
      maxSurge: 1
  selector:
    matchLabels:
      app: clean-dev
  template:
    metadata:
      labels:
        app: clean-dev
    spec:
      securityContext:
        runAsNonRoot: true
        runAsUser: 1000
        fsGroup: 1000
      containers:
        - name: clean-dev
          image: ghcr.io/mtrenker/clean-dev:main-abc1234 # Kustomize will replace this
          securityContext:
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: false
            capabilities:
              drop:
                - ALL
          ports:
            - containerPort: 3000
              name: http
          env:
            - name: NODE_ENV
              value: production
            - name: AUTH_TRUST_HOST
              value: "true"
            - name: AUTH_URL
              value: https://clean.dev
            - name: DB_USER
              valueFrom:
                secretKeyRef:
                  name: clean-dev-pg-app
                  key: username
            - name: DB_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: clean-dev-pg-app
                  key: password
            - name: DATABASE_URL
              value: postgresql://$(DB_USER):$(DB_PASSWORD)@clean-dev-pg-rw:5432/cleandev
            - name: AUTH_SECRET
              valueFrom:
                secretKeyRef:
                  name: nextauth-secrets
                  key: auth-secret
            - name: GITHUB_ID
              valueFrom:
                secretKeyRef:
                  name: nextauth-secrets
                  key: github-id
            - name: GITHUB_SECRET
              valueFrom:
                secretKeyRef:
                  name: nextauth-secrets
                  key: github-secret
            - name: ALLOWED_GITHUB_USERS
              valueFrom:
                secretKeyRef:
                  name: nextauth-secrets
                  key: allowed-github-users
            - name: SMTP_HOST
              valueFrom:
                secretKeyRef:
                  name: clean-dev-smtp
                  key: host
            - name: SMTP_PORT
              valueFrom:
                secretKeyRef:
                  name: clean-dev-smtp
                  key: port
            - name: SMTP_SECURE
              valueFrom:
                secretKeyRef:
                  name: clean-dev-smtp
                  key: secure
            - name: SMTP_USER
              valueFrom:
                secretKeyRef:
                  name: clean-dev-smtp
                  key: user
            - name: SMTP_PASS
              valueFrom:
                secretKeyRef:
                  name: clean-dev-smtp
                  key: password
            - name: SMTP_FROM
              valueFrom:
                secretKeyRef:
                  name: clean-dev-smtp
                  key: from
          resources:
            requests:
              cpu: 100m
              memory: 128Mi
            limits:
              cpu: 500m
              memory: 512Mi
          startupProbe:
            httpGet:
              path: /api/ready
              port: http
            initialDelaySeconds: 5
            periodSeconds: 5
            failureThreshold: 12
          livenessProbe:
            httpGet:
              path: /api/health
              port: http
            initialDelaySeconds: 0
            periodSeconds: 10
            timeoutSeconds: 3
            failureThreshold: 3
          readinessProbe:
            httpGet:
              path: /api/ready
              port: http
            initialDelaySeconds: 0
            periodSeconds: 5
            timeoutSeconds: 2
            failureThreshold: 2
